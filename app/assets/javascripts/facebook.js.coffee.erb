<%
  environment.context_class.instance_eval { include ApplicationHelper }
  environment.context_class.instance_eval { include Rails.application.routes.url_helpers }
%>

window.fbAsyncInit = ->
  FB.init
    apiKey: '<%= Rails.application.secrets.facebook_app_id %>'
    cookie: true
    xfbml: false
    version: 'v2.0'

  FB.getLoginStatus (response) ->
    if response.status is 'connected' or response.status is 'not authorized'
      unless $('meta[name="oac:identity"]').length
        req = $.post('<%= auth_path(:facebook) %>', {signed_request: response.authResponse.signedRequest}, 'json')
        req.done ->
          window.location.href = '<%= root_path %>'
        req.fail ->
          console.log 'Automatic signin failed'

fbLoader = (d, s, id) ->
  fjs = d.getElementsByTagName(s)[0]
  return if d.getElementById(id)?
  js = d.createElement(s)
  js.id = id
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=652000964881908&version=v2.0"
  fjs.parentNode.insertBefore(js, fjs)
fbLoader(document, 'script', 'facebook-jssdk')
